<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تاريخ بطولاتك | سجل الاختبارات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background: #fdfbf9; color: #1e293b; }
        .header-gradient { background: linear-gradient(135deg, #8b5a2b 0%, #5d3a1d 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .status-badge { font-size: 10px; padding: 4px 12px; border-radius: 99px; font-weight: 900; }
    </style>
</head>
<body class="min-h-screen pb-10">

<header class="header-gradient text-white p-5 sticky top-0 z-50 shadow-xl rounded-b-[2rem] flex justify-between items-center">
    <button onclick="window.history.back()" class="bg-white/20 hover:bg-white/30 w-11 h-11 flex items-center justify-center rounded-2xl transition-all">
        <i class="fas fa-arrow-right"></i>
    </button>
    <h1 class="text-xl font-black italic tracking-tight">درجاتك في الامتحانات</h1>
    <div class="w-11 h-11 bg-white/10 rounded-2xl flex items-center justify-center">
        <i class="fas fa-trophy text-amber-400"></i>
    </div>
</header>

<main class="max-w-2xl mx-auto p-5 mt-4">
    <div id="history-container" class="space-y-5">
        <div class="text-center py-20 opacity-50">
            <i class="fas fa-spinner fa-spin text-3xl mb-3 text-amber-800"></i>
            <p class="font-bold">ثانية واحدة.. بنجيب درجاتك</p>
        </div>
    </div>
</main>

<script>
const SUPABASE_URL = 'https://hinwzmshejgxpfuszdjv.supabase.co';
const SUPABASE_KEY = 'sb_publishable_oJIAhj1JnB9rkehdiOdNrQ_9WgMuo5y';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const studentId = localStorage.getItem('student_number');

async function loadHistory() {
    try {
        const { data: results, error } = await db
            .from('student_results')
            .select('*')
            .eq('student_id', String(studentId))
            .order('created_at', { ascending: false });

        const container = document.getElementById('history-container');

        if (!results || results.length === 0) {
            container.innerHTML = `
                <div class="text-center p-12 bg-white rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-ghost text-slate-300 text-3xl"></i>
                    </div>
                    <h3 class="font-black text-slate-800 text-lg">لسه مدخلتش ولا امتحان!</h3>
                    <p class="text-slate-400 text-sm mt-2 font-bold">مستني إيه؟ ذاكر وادخل اول امتحان دلوقتى يا بطل</p>
                </div>`;
            return;
        }

        let html = '';
        results.forEach(res => {
            const percent = (res.score / res.total_questions) * 100;
            const isPassed = percent >= 50;
            const lessonTitle = res.lesson_name || `اختبار الدرس #${res.lesson_id}`;
            const formattedDate = new Date(res.created_at).toLocaleDateString('ar-EG', { 
                day: 'numeric', 
                month: 'long' 
            });
            
            html += `
                <div class="bg-white p-6 rounded-[2rem] card-shadow border border-slate-50 flex justify-between items-center relative overflow-hidden group hover:border-amber-200 transition-all">
                    <div class="absolute right-0 top-0 bottom-0 w-2 ${isPassed ? 'bg-green-500' : 'bg-red-500'}"></div>
                    
                    <div class="pr-2">
                        <h3 class="font-black text-slate-800 text-lg mb-1 group-hover:text-amber-900 transition-colors">${lessonTitle}</h3>
                        <div class="flex items-center gap-3">
                            <span class="text-slate-400 text-[11px] font-bold">
                                <i class="far fa-calendar-check ml-1 text-amber-600"></i> يوم ${formattedDate}
                            </span>
                            <span class="status-badge ${isPassed ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}">
                                ${isPassed ? 'عاش يا بطل' : 'شد حيلك شوية'}
                            </span>
                        </div>
                    </div>

                    <div class="text-left">
                        <div class="flex flex-col items-center">
                            <span class="text-3xl font-black ${isPassed ? 'text-green-600' : 'text-red-600'} leading-none">
                                ${res.score}
                            </span>
                            <span class="text-slate-300 text-[10px] font-black uppercase border-t border-slate-100 mt-1 pt-1">
                                من ${res.total_questions}
                            </span>
                        </div>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    } catch (err) {
        document.getElementById('history-container').innerHTML = '<p class="text-center text-red-500 font-bold">حصلت مشكلة وإحنا بنجيب درجاتك..</p>';
    }
}

loadHistory();
</script>
</body>
</html>
